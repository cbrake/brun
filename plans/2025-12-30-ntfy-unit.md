# Plan: Implement Ntfy Unit

**Date:** 2025-12-30

**Status:** Implemented

## Design Decisions

- **Standard HTTP calls** (not a Go package) - ntfy API is simple, matches
  BRun's "no dependencies" philosophy
- **Logs in message body** (not attachments) - ntfy attachments require URL to
  hosted file, adds complexity

## Problem Statement

From the README.md documentation, a new unit type needs to be implemented:

> The ntfy unit allows notifications be sent out using the
> [ntfy.sh](https://ntfy.sh/) service.

The documentation describes the following fields:

- **`topic`**: Ntfy topic to post to
- **`include_output`** (optional): Include captured output from triggering unit.
  Defaults to true
- **`limit_lines`** (optional): Limit number of lines included in notification

## Current State

The README.md has been updated with documentation for the Ntfy unit, but the
implementation does not exist yet. The configuration example is marked with
`@CLAUDE fill this in`.

## Architecture Analysis

### Ntfy.sh Service

[ntfy.sh](https://ntfy.sh/) is a simple HTTP-based pub-sub notification service.
To send a notification:

```bash
curl -d "Message body" ntfy.sh/your-topic
```

Or with more options:

```bash
curl \
  -H "Title: Build Failed" \
  -H "Priority: high" \
  -H "Tags: warning" \
  -d "Build output here..." \
  ntfy.sh/your-topic
```

### Existing Patterns

The `EmailUnit` in `email.go` provides an excellent template for implementing
the Ntfy unit:

- Similar fields: `include_output`, `limit_lines`
- Similar methods: `SetOutput()`, `SetTriggeringUnit()`, `SetTriggerError()`
- Same pattern for building message body with line limiting

### Files to Create/Modify

1. **New file: `ntfy.go`** - Ntfy unit implementation
2. **New file: `ntfy_test.go`** - Unit tests
3. **Modify: `config.go`** - Add `Ntfy` to `UnitConfigWrapper` and
   `CreateUnits()`
4. **Modify: `orchestrator.go`** - Add NtfyUnit to output passing logic
5. **Modify: `README.md`** - Fill in configuration example

## Implementation Plan

### 1. Create NtfyConfig and NtfyUnit Types

**File:** `ntfy.go`

```go
// NtfyConfig represents the configuration for an Ntfy unit
type NtfyConfig struct {
	UnitConfig    `yaml:",inline"`
	Topic         string `yaml:"topic"`
	Server        string `yaml:"server,omitempty"`        // Optional, defaults to ntfy.sh
	TitlePrefix   string `yaml:"title_prefix,omitempty"`  // Optional notification title prefix
	Priority      string `yaml:"priority,omitempty"`      // Optional: min, low, default, high, urgent
	Tags          string `yaml:"tags,omitempty"`          // Optional comma-separated tags/emojis
	IncludeOutput *bool  `yaml:"include_output,omitempty"`
	LimitLines    int    `yaml:"limit_lines,omitempty"`
}

// NtfyUnit sends notifications via ntfy.sh
type NtfyUnit struct {
	name           string
	topic          string
	server         string
	titlePrefix    string
	priority       string
	tags           string
	includeOutput  bool
	limitLines     int
	output         string   // Output from the triggering unit
	triggeringUnit string   // Name of the unit that triggered this
	triggerError   error    // Error from the triggering unit (if any)
	onSuccess      []string
	onFailure      []string
	always         []string
}
```

### 2. Implement NtfyUnit Methods

**Required methods for Unit interface:**

- `Name() string`
- `Type() string`
- `Run(ctx context.Context) error`

**Additional methods (same pattern as EmailUnit):**

- `SetOutput(output string)`
- `SetTriggeringUnit(unitName string)`
- `SetTriggerError(err error)`
- `OnSuccess() []string`
- `OnFailure() []string`
- `Always() []string`

**Core implementation:**

- Build notification message (similar to email body building)
- Apply line limiting if configured
- Send HTTP POST to ntfy.sh (or custom server)
- Include appropriate headers (Title, Priority, Tags)

### 3. Update config.go

**Add to UnitConfigWrapper struct:**

```go
Ntfy   *NtfyConfig   `yaml:"ntfy,omitempty"`
```

**Add to CreateUnits() function:**

```go
if wrapper.Ntfy != nil {
	cfg := wrapper.Ntfy
	if cfg.Name == "" {
		return nil, fmt.Errorf("unit %d: name is required", i)
	}
	if cfg.Topic == "" {
		return nil, fmt.Errorf("unit %d: topic is required", i)
	}

	// Set defaults
	server := cfg.Server
	if server == "" {
		server = "https://ntfy.sh"
	}

	includeOutput := true
	if cfg.IncludeOutput != nil {
		includeOutput = *cfg.IncludeOutput
	}

	unit := NewNtfyUnit(
		cfg.Name,
		cfg.Topic,
		server,
		cfg.TitlePrefix,
		cfg.Priority,
		cfg.Tags,
		includeOutput,
		cfg.LimitLines,
		cfg.OnSuccess,
		cfg.OnFailure,
		cfg.Always,
	)
	units = append(units, unit)
}
```

### 4. Update README.md Configuration Example

Replace `@CLAUDE fill this in.` with:

```yaml
config:
  state_location: /var/lib/brun/state.yaml

units:
  - boot:
      name: boot-trigger
      on_success:
        - build

  - run:
      name: build
      script: |
        go build -o brun ./cmd/brun
        go test -v
      on_failure:
        - notify-failure
      on_success:
        - notify-success

  - ntfy:
      name: notify-failure
      topic: my-build-alerts
      title_prefix: Build Failed
      priority: high
      tags: warning,skull
      include_output: true
      limit_lines: 50

  - ntfy:
      name: notify-success
      topic: my-build-alerts
      title_prefix: Build Succeeded
      priority: default
      tags: white_check_mark
      include_output: false
```

### 5. Create Unit Tests

**File:** `ntfy_test.go`

Tests to implement:

1. `TestNewNtfyUnit` - Constructor creates unit with correct fields
2. `TestNtfyUnit_Name` - Returns correct name
3. `TestNtfyUnit_Type` - Returns "ntfy"
4. `TestNtfyUnit_SetOutput` - Sets output correctly
5. `TestNtfyUnit_SetTriggeringUnit` - Sets triggering unit correctly
6. `TestNtfyUnit_SetTriggerError` - Sets trigger error correctly
7. `TestNtfyUnit_LimitLines` - Line limiting works correctly
8. `TestNtfyUnit_DefaultServer` - Default server is ntfy.sh
9. `TestNtfyUnit_CustomServer` - Custom server is used when specified
10. `TestNtfyUnit_BuildMessage` - Message body is built correctly

Use httptest package to mock the ntfy server for integration tests.

## Additional Considerations

### Extended Fields (Implemented)

The documentation only specifies `topic`, `include_output`, and `limit_lines`,
but ntfy.sh supports additional useful fields which were all implemented:

- **`server`**: Allow self-hosted ntfy servers (default: `https://ntfy.sh`)
- **`title_prefix`**: Notification title prefix (full title: `<prefix>: <unit>:<status>`)
- **`priority`**: min, low, default, high, urgent
- **`tags`**: Comma-separated tags/emojis

These were added as optional fields since they enhance functionality without
breaking the documented interface.

### Authentication (Future Enhancement)

ntfy.sh supports authentication for private topics:

- Username/password
- Access tokens

This could be added later if needed.

## Implementation Steps

1. [x] Create `ntfy.go` with NtfyConfig and NtfyUnit types
2. [x] Implement NewNtfyUnit constructor
3. [x] Implement Unit interface methods (Name, Type, Run)
4. [x] Implement output-related methods (SetOutput, SetTriggeringUnit,
       SetTriggerError)
5. [x] Implement trigger chain methods (OnSuccess, OnFailure, Always)
6. [x] Update `config.go` - add Ntfy to UnitConfigWrapper
7. [x] Update `config.go` - add Ntfy handling in CreateUnits()
8. [x] Update `orchestrator.go` - add NtfyUnit output passing
9. [x] Create `ntfy_test.go` with unit tests
10. [x] Update README.md with configuration example
11. [x] Run tests: `go test -v` - All tests pass
12. [x] Build and verify: `go build -o brun ./cmd/brun` - Build successful

## Risk Assessment

**Low Risk:**

- New unit type - additive change, no impact on existing functionality
- Follows established patterns from EmailUnit

**Medium Risk:**

- HTTP request to external service - need proper error handling and timeouts

**Mitigation:**

- Use context with timeout for HTTP requests
- Comprehensive unit tests with mocked HTTP server
- Follow existing EmailUnit patterns closely

## Success Criteria

1. [x] `go build` succeeds with no errors
2. [x] `go test -v` passes all tests
3. [x] Ntfy unit can be configured in YAML
4. [x] Notifications are sent to ntfy.sh on trigger
5. [x] `include_output` includes/excludes output as expected
6. [x] `limit_lines` properly limits output
7. [x] Optional fields (server, title_prefix, priority, tags) work correctly
8. [x] README.md has complete configuration example
